{
  "StripeConnectLambdaPolicy": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "SecretsManagerAccess",
        "Effect": "Allow",
        "Action": [
          "secretsmanager:GetSecretValue"
        ],
        "Resource": [
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_SECRET_KEY-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_WEBHOOK_SECRET-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_APP_URL-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_PROVIDER_TABLE_NAME-*"
        ]
      },
      {
        "Sid": "DynamoDBAccess",
        "Effect": "Allow",
        "Action": [
          "dynamodb:GetItem",
          "dynamodb:PutItem",
          "dynamodb:UpdateItem",
          "dynamodb:Query"
        ],
        "Resource": [
          "arn:aws:dynamodb:*:*:table/Provider-*",
          "arn:aws:dynamodb:*:*:table/Booking-*",
          "arn:aws:dynamodb:*:*:table/Transaction-*"
        ]
      },
      {
        "Sid": "CloudWatchLogsAccess",
        "Effect": "Allow",
        "Action": [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ],
        "Resource": [
          "arn:aws:logs:*:*:log-group:/aws/lambda/stripe-connect",
          "arn:aws:logs:*:*:log-group:/aws/lambda/stripe-connect:*"
        ]
      },
      {
        "Sid": "XRayTracing",
        "Effect": "Allow",
        "Action": [
          "xray:PutTraceSegments",
          "xray:PutTelemetryRecords"
        ],
        "Resource": "*"
      }
    ]
  },
  "StripeWebhookLambdaPolicy": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "SecretsManagerAccess",
        "Effect": "Allow",
        "Action": [
          "secretsmanager:GetSecretValue"
        ],
        "Resource": [
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_SECRET_KEY-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_WEBHOOK_SECRET-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_PROVIDER_TABLE_NAME-*"
        ]
      },
      {
        "Sid": "DynamoDBAccess",
        "Effect": "Allow",
        "Action": [
          "dynamodb:UpdateItem",
          "dynamodb:PutItem"
        ],
        "Resource": [
          "arn:aws:dynamodb:*:*:table/Provider-*",
          "arn:aws:dynamodb:*:*:table/Booking-*",
          "arn:aws:dynamodb:*:*:table/Transaction-*",
          "arn:aws:dynamodb:*:*:table/PayoutHistory-*"
        ]
      },
      {
        "Sid": "SNSNotifications",
        "Effect": "Allow",
        "Action": [
          "sns:Publish"
        ],
        "Resource": [
          "arn:aws:sns:*:*:payment-notifications",
          "arn:aws:sns:*:*:dispute-notifications"
        ]
      },
      {
        "Sid": "CloudWatchLogsAccess",
        "Effect": "Allow",
        "Action": [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ],
        "Resource": [
          "arn:aws:logs:*:*:log-group:/aws/lambda/stripe-webhook",
          "arn:aws:logs:*:*:log-group:/aws/lambda/stripe-webhook:*"
        ]
      },
      {
        "Sid": "XRayTracing",
        "Effect": "Allow",
        "Action": [
          "xray:PutTraceSegments",
          "xray:PutTelemetryRecords"
        ],
        "Resource": "*"
      }
    ]
  },
  "SecretsManagerRotationPolicy": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "RotateStripeSecrets",
        "Effect": "Allow",
        "Action": [
          "secretsmanager:RotateSecret",
          "secretsmanager:GetSecretValue",
          "secretsmanager:DescribeSecret",
          "secretsmanager:PutSecretValue",
          "secretsmanager:UpdateSecretVersionStage"
        ],
        "Resource": [
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_SECRET_KEY-*",
          "arn:aws:secretsmanager:*:*:secret:AMPLIFY_*_STRIPE_WEBHOOK_SECRET-*"
        ]
      }
    ]
  },
  "MonitoringAndCompliancePolicy": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "CloudTrailAccess",
        "Effect": "Allow",
        "Action": [
          "cloudtrail:LookupEvents"
        ],
        "Resource": "*",
        "Condition": {
          "StringEquals": {
            "cloudtrail:EventName": [
              "GetSecretValue",
              "UpdateItem",
              "PutItem"
            ]
          }
        }
      },
      {
        "Sid": "CloudWatchMetrics",
        "Effect": "Allow",
        "Action": [
          "cloudwatch:PutMetricData"
        ],
        "Resource": "*",
        "Condition": {
          "StringEquals": {
            "cloudwatch:namespace": [
              "AWS/Lambda",
              "Stripe/Payments",
              "Marketplace/Security"
            ]
          }
        }
      },
      {
        "Sid": "ConfigComplianceChecks",
        "Effect": "Allow",
        "Action": [
          "config:PutEvaluations"
        ],
        "Resource": "*"
      }
    ]
  },
  "SecurityBestPractices": {
    "PolicyNotes": [
      "1. LEAST PRIVILEGE: Each function has minimal required permissions",
      "2. RESOURCE CONSTRAINTS: ARNs use wildcards only where necessary",
      "3. CONDITION CONSTRAINTS: Policies include conditions to limit scope",
      "4. SEPARATION OF DUTIES: Different policies for different functions",
      "5. MONITORING: All secret access is logged via CloudTrail",
      "6. ENCRYPTION: All data encrypted at rest and in transit",
      "7. ROTATION: Secrets can be rotated without code changes",
      "8. COMPLIANCE: Policies support SOC2, PCI-DSS, and GDPR requirements"
    ],
    "SecurityChecklist": [
      "✅ No wildcard (*) permissions on sensitive resources",
      "✅ No cross-account access without explicit business need", 
      "✅ All secret access logged and monitored",
      "✅ IAM policies regularly reviewed and updated",
      "✅ Unused permissions removed quarterly",
      "✅ MFA required for secret management operations",
      "✅ VPC endpoints used for service communication where possible",
      "✅ Network ACLs restrict traffic to necessary ports only"
    ],
    "ComplianceMapping": {
      "PCI_DSS": [
        "Requirement 3.4: Encrypted storage of payment data references",
        "Requirement 7.1: Limit access to cardholder data by business need",
        "Requirement 8.7: All access to databases with cardholder data secured",
        "Requirement 10.2: Audit trails for access to cardholder data"
      ],
      "SOC2": [
        "CC6.1: Logical and physical access controls",
        "CC6.2: System uses encryption to protect data",
        "CC6.3: Segregation of duties implemented",
        "CC7.2: System monitors for security events"
      ],
      "GDPR": [
        "Article 25: Data protection by design and by default",
        "Article 32: Security of processing",
        "Article 33: Notification of data breach",
        "Article 35: Data protection impact assessment"
      ]
    }
  }
}